name: Deploy to EC2

on:
  push:
    branches:
      - main
  workflow_dispatch:
    inputs:
      deploy_backend:
        description: 'Deploy Backend'
        required: false
        default: 'true'
        type: boolean
      deploy_frontend:
        description: 'Deploy Frontend'
        required: false
        default: 'true'
        type: boolean

jobs:
  deploy-backend:
    name: Deploy Backend to EC2
    runs-on: ubuntu-latest
    if: |
      (contains(github.event.head_commit.modified, 'fibo-backend/') || 
       contains(github.event.head_commit.added, 'fibo-backend/') ||
       github.event_name == 'workflow_dispatch') &&
      (github.event_name != 'workflow_dispatch' || github.event.inputs.deploy_backend == 'true')
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Deploy Backend to EC2
      uses: appleboy/ssh-action@v1.0.0
      with:
        host: ${{ secrets.EC2_HOST }}
        username: ${{ secrets.EC2_USER }}
        key: ${{ secrets.EC2_SSH_KEY }}
        port: ${{ secrets.EC2_SSH_PORT || 22 }}
        timeout: 300s
        script: |
          set -e
          echo "ğŸš€ Starting backend deployment..."
          
          cd /opt/fibonauti/fibo-backend
          
          echo "ğŸ“¥ Pulling latest code..."
          git fetch origin
          git reset --hard origin/main
          
          echo "ğŸ Setting up Python environment..."
          source venv/bin/activate
          pip install --upgrade pip --quiet
          
          echo "ğŸ“¦ Installing dependencies..."
          pip install -r requirements.txt --quiet
          
          echo "ğŸ—„ï¸ Running database migrations..."
          alembic upgrade head
          
          echo "ğŸ”„ Restarting service..."
          sudo systemctl restart fibo-backend
          
          echo "â³ Waiting for service to start..."
          sleep 5
          
          echo "âœ… Checking service status..."
          if sudo systemctl is-active --quiet fibo-backend; then
            echo "âœ… Backend service is running!"
            sudo systemctl status fibo-backend --no-pager -l
          else
            echo "âŒ Backend service failed to start!"
            sudo journalctl -u fibo-backend -n 50 --no-pager
            exit 1
          fi
          
          echo "ğŸ‰ Backend deployment completed successfully!"

    - name: Verify Backend Health
      if: always()
      uses: appleboy/ssh-action@v1.0.0
      with:
        host: ${{ secrets.EC2_HOST }}
        username: ${{ secrets.EC2_USER }}
        key: ${{ secrets.EC2_SSH_KEY }}
        port: ${{ secrets.EC2_SSH_PORT || 22 }}
        script: |
          echo "ğŸ¥ Checking backend health endpoint..."
          sleep 3
          if curl -f http://localhost:8000/api/v1/health > /dev/null 2>&1; then
            echo "âœ… Backend health check passed!"
          else
            echo "âš ï¸ Backend health check failed (service may still be starting)"
          fi

  deploy-frontend:
    name: Deploy Frontend to EC2
    runs-on: ubuntu-latest
    if: |
      (contains(github.event.head_commit.modified, 'frontend/') || 
       contains(github.event.head_commit.added, 'frontend/') ||
       github.event_name == 'workflow_dispatch') &&
      (github.event_name != 'workflow_dispatch' || github.event.inputs.deploy_frontend == 'true')
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Deploy Frontend to EC2
      uses: appleboy/ssh-action@v1.0.0
      with:
        host: ${{ secrets.EC2_HOST }}
        username: ${{ secrets.EC2_USER }}
        key: ${{ secrets.EC2_SSH_KEY }}
        port: ${{ secrets.EC2_SSH_PORT || 22 }}
        timeout: 600s
        script: |
          set -e
          echo "ğŸš€ Starting frontend deployment..."
          
          cd /opt/fibonauti/fibo-dashboard-ui
          
          echo "ğŸ“¥ Pulling latest code..."
          git fetch origin
          git reset --hard origin/main
          
          echo "ğŸ“¦ Installing dependencies..."
          npm ci --legacy-peer-deps --silent
          
          echo "ğŸ—ï¸ Building Angular application..."
          npm run build -- --configuration production
          
          echo "âœ… Verifying build output..."
          if [ ! -d "dist/fibo-dashboard-ui/browser" ]; then
            echo "âŒ Build failed! dist/fibo-dashboard-ui/browser not found"
            exit 1
          fi
          
          echo "ğŸ“Š Build size:"
          du -sh dist/fibo-dashboard-ui/browser
          
          echo "ğŸ”„ Testing Nginx configuration..."
          sudo nginx -t
          
          echo "ğŸ”„ Reloading Nginx..."
          sudo systemctl reload nginx
          
          echo "âœ… Verifying Nginx status..."
          if sudo systemctl is-active --quiet nginx; then
            echo "âœ… Nginx is running!"
          else
            echo "âŒ Nginx failed to reload!"
            sudo systemctl status nginx --no-pager -l
            exit 1
          fi
          
          echo "ğŸ‰ Frontend deployment completed successfully!"

